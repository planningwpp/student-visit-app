<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="[https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css](https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css)" rel="stylesheet">
    <link href="[https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css](https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css)" rel="stylesheet">
    <script src="[https://cdn.jsdelivr.net/npm/sweetalert2@11](https://cdn.jsdelivr.net/npm/sweetalert2@11)"></script>
    
    <style>
@import url('[https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500&display=swap](https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500&display=swap)');
body { 
  font-family: 'Kanit', sans-serif; 
  background-color: #f0f2f5; 
  display: flex; 
  flex-direction: column; 
  min-height: 100vh; 
}
/* (ใหม่) จัดการ layout หลักให้ footer อยู่ด้านล่าง */
.main-content {
  flex: 1;
}

#loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.9); display: flex; justify-content: center; align-items: center; z-index: 9999; flex-direction: column; }
#login-screen, 
#student-selection-screen, 
#main-form-screen, 
#dashboard-screen { display: none; } /* (ใหม่) เพิ่ม #dashboard-screen */

#login-screen, 
#student-selection-screen, 
#dashboard-screen { padding-top: 60px; }

header { position: sticky; top: 0; z-index: 1020; }
#form-sidebar { position: sticky; top: 70px; height: calc(100vh - 70px); overflow-y: auto; }
.nav-pills .nav-link { color: #555; border-radius: 0.5rem; }
.nav-pills .nav-link.active { background-color: #0d6efd; color: white; }
.nav-pills .nav-link:hover { background-color: #e9ecef; }
.form-section { display: none; }
.form-section.active { display: block; }
.conditional-subsection { display: none; background-color: #f8f9fa; border: 1px solid #dee2e6; }
#household-member-list input { min-width: 100px; }
.delete-row-btn { width: 40px; height: 40px; }
.swal2-popup { font-size: 0.9rem !important; }

.preview-container {
  position: relative;
  width: 150px;
  display: none;
}
.preview-container .img-thumbnail {
  max-height: 150px;
}
.preview-container .delete-image-btn {
  position: absolute;
  top: 0;
  right: 0;
  border-radius: 50%;
}

/* (ใหม่) CSS สำหรับ Footer */
footer {
  font-size: 0.85rem;
  color: #6c757d;
  background-color: #f8f9fa;
  border-top: 1px solid #dee2e6;
  width: 100%;
}
    </style>
  </head>
  <body>

    <div id="loading-screen">
      <div class="spinner-border text-primary" role="status"></div>
      <p class="mt-3 fs-5 text-muted">กำลังเริ่มต้น...</p>
    </div>

        <div class="main-content">

      <div id="login-screen">
                <div class="container">
          <div class="row justify-content-center">
            <div class="col-md-6 col-lg-5">
<div class="card shadow border-0 p-4">
                <h3 class="text-center mb-4 fw-bold text-primary">ระบบเยี่ยมบ้านนักเรียน</h3>
                <form id="manual-login-form">
                  <div class="mb-3">
                    <label for="login-email" class="form-label">Email (ที่ลงทะเบียน)</label>
                    <input type="email" class="form-control" id="login-email" required>
                  </div>
<div class="mb-3">
                    <label for="login-password" class="form-label">Password (จากชีต Users)</label>
                    <input type="password" class="form-control" id="login-password" required>
                  </div>
<div id="login-error-message" class="alert alert-danger" style="display: none;"></div>
                  <button type="submit" id="login-btn" class="btn btn-primary btn-lg w-100">
                    <i class="bi bi-box-arrow-in-right me-2"></i> เข้าสู่ระบบ
                  </button>
                </form>
</div>
            </div>
          </div>
        </div>
      </div>

      <div id="student-selection-screen" class="container">
        <div class="row justify-content-center">
          <div class="col-md-10 col-lg-8">
<div class="card shadow border-0 p-4">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="mb-0">ยินดีต้อนรับ, <span id="user-name-display" class="text-primary"></span></h4>
                <button id="logout-btn" class="btn btn-sm btn-outline-danger">Logout</button>
              </div>
              <div class="row g-3">
<div class="col-md-6"><label for="class-select" class="form-label fw-bold">1. เลือกระดับชั้น</label><select id="class-select" class="form-select form-select-lg"><option value="">-- กรุณาเลือก --</option></select></div>
<div class="col-md-6"><label for="student-select" class="form-label fw-bold">2. เลือกนักเรียน</label><select id="student-select" class="form-select form-select-lg" disabled><option value="">-- กรุณาเลือกระดับชั้นก่อน --</option></select></div>
              </div>
<div class="row g-3 mt-3">
<div class="col-md-6"><label for="semester-select" class="form-label fw-bold">3. ภาคเรียน</label><input type="number" id="semester-select" class="form-control form-control-lg" placeholder="เช่น 1, 2" value="1"></div>
<div class="col-md-6"><label for="year-select" class="form-label fw-bold">4. ปีการศึกษา</label><input type="number" id="year-select" class="form-control form-control-lg" placeholder="พ.ศ. เช่น 2568" value="2568"></div>
              </div>
              
                            <div class="d-grid gap-2 mt-4">
                <button id="start-form-btn" class="btn btn-success btn-lg" disabled><i class="bi bi-pencil-square me-2"></i> เริ่มกรอกข้อมูล</button>
                <button id="view-dashboard-btn" class="btn btn-outline-primary"><i class="bi bi-bar-chart-line-fill me-2"></i> ดู Dashboard (สรุปผล)</button>
              </div>
              
          </div>
        </div>
      </div>
    </div>

      <div id="main-form-screen" class="container-fluid">
                <header class="d-flex flex-wrap justify-content-between align-items-center p-3 bg-white shadow-sm mb-3">
          <div><h5 class="mb-0 fw-bold text-primary">แบบฟอร์ม นร./กสศ.01</h5><span class="text-muted" id="student-name-header"></span></div>
          <div class="mt-2 mt-md-0">
            <button id="save-to-sheets-btn" class="btn btn-primary me-2" disabled><span class="spinner-border spinner-border-sm" role="status" aria-hidden="true" style="display: none;"></span><i class="bi bi-cloud-arrow-up me-2"></i> บันทึก (0)</button>
<button id="export-pdf-btn" class="btn btn-danger me-2" disabled><i class="bi bi-file-earmark-pdf me-2"></i> ส่งออก PDF (ยังไม่รองรับ)</button>
            <button id="back-to-selection-btn" class="btn btn-secondary"><i class="bi bi-arrow-left me-2"></i> กลับ</button>
          </div>
        </header>
<div class="row">
          <nav id="form-sidebar" class="col-md-3 col-lg-2 d-md-block bg-white sidebar py-3">
                      </nav>
<main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 py-3">
            <form id="visit-form">
                          </form>
          </main>
        </div>
      </div>

            <div id="dashboard-screen" class="container">
        <div class="row justify-content-center">
          <div class="col-md-10 col-lg-8">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h3 class="mb-0">Dashboard สรุปผลการเยี่ยมบ้าน</h3>
              <button id="back-to-selection-from-dash-btn" class="btn btn-secondary"><i class="bi bi-arrow-left me-2"></i> กลับ</button>
            </div>
            <div class="card shadow border-0 p-4">
              <div id="dashboard-content">
                                <div class="text-center p-5">
                  <div class="spinner-border text-primary" role="status"></div>
                  <p class="mt-3">กำลังโหลดข้อมูลสรุป...</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>         <footer class="container-fluid text-center p-3 mt-4">
      <p class="mb-1">พัฒนาโดย นายอชิตพล บุณรัตน์ ครู โรงเรียนวังโพรงพิทยาคม สพม.พิษณุโลก อุตรดิตถ์</p>
      <p class="mb-0">&copy; 2025 WPP Student Care</p>
    </footer>


    <script src="[https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js](https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js)"></script>
    
    <script>
      /*
       * ===================================================================
       * GLOBAL VARIABLES
       * ===================================================================
       */
      
const SHEETDB_API_URL = "[https://sheetdb.io/api/v1/bczb66wme054a](https://sheetdb.io/api/v1/bczb66wme054a)"; 
const CLOUDINARY_CLOUD_NAME = "dzzdmlei5";
      const CLOUDINARY_UPLOAD_PRESET = "ml_default";
      const CLOUDINARY_URL = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`;

      const gState = {
        currentUser: null,
        selectedStudentId: null,
        selectedStudentName: null,
        currentRecordId: null,
        originalData: {},
        changesToPush: {},
        householdMembers: [],
        isLoading: false,
        isFormValid: false
      };
      
      let SCREENS = {};
      let el = {};

      /*
       * ===================================================================
       * ENTRY POINT (เริ่มต้นระบบ)
       * ===================================================================
       */
      document.addEventListener("DOMContentLoaded", () => {
        SCREENS = {
          loading: document.getElementById('loading-screen'),
          login: document.getElementById('login-screen'),
          selection: document.getElementById('student-selection-screen'),
          form: document.getElementById('main-form-screen'),
          dashboard: document.getElementById('dashboard-screen') // (ใหม่)
        };
        el = {
          // ... (el เดิมทั้งหมด) ...
          loginForm: document.getElementById('manual-login-form'),
          loginEmailInput: document.getElementById('login-email'),
          loginPasswordInput: document.getElementById('login-password'),
          loginBtn: document.getElementById('login-btn'),
          loginErrorMessage: document.getElementById('login-error-message'),
          logoutBtn: document.getElementById('logout-btn'),
          userNameDisplay: document.getElementById('user-name-display'),
          classSelect: document.getElementById('class-select'),
          studentSelect: document.getElementById('student-select'),
          semesterSelect: document.getElementById('semester-select'),
          yearSelect: document.getElementById('year-select'),
          startFormBtn: document.getElementById('start-form-btn'),
          backBtn: document.getElementById('back-to-selection-btn'),
          saveBtn: document.getElementById('save-to-sheets-btn'),
          studentNameHeader: document.getElementById('student-name-header'),
          sidebarLinks: document.querySelectorAll('#form-sidebar .nav-link'),
          formSections: document.querySelectorAll('.form-section'),
          gpsBtn: document.getElementById('get-gps-btn'),
          livesWithSelect: document.getElementById('Q1_LivesWith'),
          q4Content: document.getElementById('q4-content'),
          s4SidebarLink: document.querySelector('a[href="#section-4"]'),
          q3_1_Status: document.querySelectorAll('input[name="Q3_1_DependencyStatus"]'),
          q3_1_SubOptions: document.getElementById('q3-1-sub-options'),
          q3_4_Status: document.querySelectorAll('input[name="Q3_4_AgricultureStatus"]'),
          q3_4_SubOptions: document.getElementById('q3-4-sub-options'),
          householdTbody: document.getElementById('household-member-list'),
          addMemberBtn: document.getElementById('add-member-btn'),
          totalMembersInput: document.getElementById('Q2_TotalMembers'),
          totalIncomeInput: document.getElementById('Q2_HouseholdIncome_Total'),
          perCapitaIncomeInput: document.getElementById('Q2_HouseholdIncome_PerCapita'),
          progressBar: document.getElementById('progress-bar'),

          // (ใหม่) เพิ่ม el สำหรับ Dashboard
          viewDashboardBtn: document.getElementById('view-dashboard-btn'),
          backFromDashBtn: document.getElementById('back-to-selection-from-dash-btn'),
          dashboardContent: document.getElementById('dashboard-content')
        };
        
        showScreen('login');
        bindEventListeners();
        attachFormListeners();
        el.yearSelect.value = new Date().getFullYear() + 543;
      });
      
      /*
       * ===================================================================
       * LOGIN & STUDENT SELECTION
       * ===================================================================
       */
      async function handleManualLogin(event) {
        event.preventDefault();
        setLoading(true, 'กำลังตรวจสอบข้อมูล...');
        el.loginBtn.disabled = true;
        el.loginErrorMessage.style.display = 'none';

        try {
          const email = el.loginEmailInput.value;
          const password = el.loginPasswordInput.value;
          const url = `${SHEETDB_API_URL}/search?Email=${encodeURIComponent(email)}&Password=${encodeURIComponent(password)}&sheet=Users`;
          const response = await fetch(url);
          if (!response.ok) {
            throw new Error(`NetworkError: การเชื่อมต่อล้มเหลว (HTTP ${response.status})`);
          }
          const data = await response.json();
          if (data && data.length > 0) {
            handleLoginSuccess(data[0]);
          } else {
            handleLoginFailure("อีเมล หรือ รหัสผ่านไม่ถูกต้อง");
          }
        } catch (error) {
          handleLoginFailure(error.message);
        }
      }

      async function handleLoginSuccess(user) {
        if (user && user.Email) { 
          gState.currentUser = user; 
          el.userNameDisplay.textContent = user.TeacherName;
          showScreen('selection');
          
          try {
            setLoading(true, 'กำลังโหลดข้อมูลชั้นเรียน...');
            const response = await fetch(`${SHEETDB_API_URL}?sheet=Students`);
            if (!response.ok) throw new Error("NetworkError: ไม่สามารถดึงข้อมูลนักเรียน");
            
            const allStudents = await response.json();
            const allClassesSet = new Set(allStudents.map(s => s.Class.trim()));
            let filteredClasses = Array.from(allClassesSet).sort();

            if (user.Role !== 'Admin' && user.AssignedClasses && user.AssignedClasses.trim() !== "") {
              const allowedClassesSet = new Set(user.AssignedClasses.split(',').map(c => c.trim().toLowerCase()));
              filteredClasses = filteredClasses.filter(c => allowedClassesSet.has(c.toLowerCase()));
            }
            
            populateClassDropdown(filteredClasses);
            setLoading(false);
            
          } catch (error) {
            handleError(error);
          }
            
        } else {
          handleLoginFailure("ข้อมูลผู้ใช้ไม่ถูกต้อง (ไม่พบ Email)");
        }
      }

      function handleLoginFailure(error) {
        setLoading(false);
        gState.currentUser = null;
        showScreen('login');
        el.loginBtn.disabled = false;
        el.loginErrorMessage.textContent = String(error);
        el.loginErrorMessage.style.display = 'block';
      }
      
      function handleLogout() {
         gState.currentUser = null;
         el.loginEmailInput.value = '';
         el.loginPasswordInput.value = '';
         el.loginErrorMessage.style.display = 'none';
         showScreen('login');
      }
      
      function showScreen(screenId) {
        if (!SCREENS.loading) { console.error("SCREENS object not initialized!"); return; }
        Object.values(SCREENS).forEach(screen => {
          if(screen) screen.style.display = 'none';
        });
        if (SCREENS[screenId]) {
          SCREENS[screenId].style.display = 'block';
        }
      }

      function populateClassDropdown(classes) {
        el.classSelect.innerHTML = '<option value="">-- กรุณาเลือก --</option>';
        classes.forEach(className => {
          const option = new Option(className, className);
          el.classSelect.add(option);
        });
      }

      async function handleClassChange() {
        const className = el.classSelect.value;
        if (!className) {
          el.studentSelect.innerHTML = '<option value="">-- กรุณาเลือกระดับชั้นก่อน --</option>';
          el.studentSelect.disabled = true;
          el.startFormBtn.disabled = true;
          return;
        }
        el.studentSelect.disabled = true;
        setLoading(true, 'กำลังโหลดรายชื่อนักเรียน...');

        try {
          const url = `${SHEETDB_API_URL}/search?Class=${encodeURIComponent(className)}&sheet=Students`;
          const response = await fetch(url);
          if (!response.ok) throw new Error("NetworkError: ไม่สามารถดึงรายชื่อนักเรียน");
          const students = await response.json();
          students.sort((a, b) => parseInt(a.StudentNumber, 10) - parseInt(b.StudentNumber, 10));
          populateStudentDropdown(students);
          setLoading(false);
        } catch (error) {
          handleError(error);
        }
      }
      
      function populateStudentDropdown(students) {
        el.studentSelect.innerHTML = '<option value="">-- กรุณาเลือก --</option>';
        students.forEach(student => {
          const name = `${student.Prefix} ${student.FirstName} ${student.LastName} (เลขที่ ${student.StudentNumber})`;
          const option = new Option(name, student.StudentID);
          el.studentSelect.add(option);
        });
        el.studentSelect.disabled = false;
        validateStartButton();
      }
      
      function validateStartButton() {
        const hasClass = el.classSelect.value;
        const hasStudent = el.studentSelect.value;
        const hasSemester = el.semesterSelect.value;
        const hasYear = el.yearSelect.value;
        el.startFormBtn.disabled = !(hasClass && hasStudent && hasSemester && hasYear);
      }
      
      /*
       * ===================================================================
       * (ใหม่) DASHBOARD FUNCTIONS
       * ===================================================================
       */
      
      async function handleLoadDashboard() {
        showScreen('dashboard');
        el.dashboardContent.innerHTML = `
            <div class="text-center p-5">
              <div class="spinner-border text-primary" role="status"></div>
              <p class="mt-3">กำลังโหลดข้อมูลสรุป...</p>
            </div>`;

        try {
          // --- นี่คือส่วนที่ซับซ้อน และจะทำในขั้นต่อไป ---
          // 1. ดึงข้อมูลนักเรียนทั้งหมด
          // const studentResponse = await fetch(`${SHEETDB_API_URL}?sheet=Students`);
          // const allStudents = await studentResponse.json();

          // 2. ดึงข้อมูลการเยี่ยมบ้านทั้งหมด
          // const visitResponse = await fetch(`${SHEETDB_API_URL}?sheet=VisitData`);
          // const allVisits = await visitResponse.json();

          // 3. สร้าง object ของ visit data เพื่อให้ค้นหาง่าย
          // const visitMap = new Map(allVisits.map(visit => [visit.RecordID, visit]));

          // 4. ประมวลผลและจัดกลุ่มข้อมูล (Aggregate)
          // const stats = aggregateDashboardData(allStudents, visitMap);

          // 5. แสดงผล (Render)
          // renderDashboard(stats);
          
          // ---ชั่วคราว: แสดงว่ายังไม่เสร็จ---
          el.dashboardContent.innerHTML = `
            <div class='alert alert-info'>
              <strong>ฟีเจอร์ Dashboard อยู่ในระหว่างการพัฒนา</strong>
              <p>ส่วนนี้จะต้องใช้การดึงข้อมูลทั้งหมดมาประมวลผล ซึ่งจะอัปเดตในขั้นตอนถัดไปครับ</p>
              <p><strong>ขั้นตอนต่อไป:</strong></p>
              <ol>
                <li>ดึงข้อมูลจาก <code>sheet=Students</code> และ <code>sheet=VisitData</code></li>
                <li>ประมวลผลข้อมูลเพื่อนับจำนวนนักเรียน/ห้อง และสถานะการเยี่ยมบ้าน</li>
                <li>สร้าง UI เพื่อแสดงผลสรุป</li>
              </ol>
            </div>`;

        } catch (error) {
          handleError(error);
          el.dashboardContent.innerHTML = `<div class='alert alert-danger'>${error.message}</div>`;
        }
      }
      
      /*
       * ===================================================================
       * FORM LOADING & DISPLAY
       * ===================================================================
       */

      /*
       * ===================================================================
       * HOUSEHOLD MEMBERS
       * ===================================================================
       */
      function renderHouseholdTable(members = []) {
        gState.householdMembers = members;
        el.householdTbody.innerHTML = '';
        if (gState.householdMembers.length === 0 && gState.originalData.studentMaster) {
          const studentMaster = gState.originalData.studentMaster;
          gState.householdMembers.push({
            RecordID: gState.currentRecordId, MemberNo: 1,
            MemberName: `${studentMaster.FirstName} ${studentMaster.LastName}`,
            Relation: 'นักเรียน', CitizenID: studentMaster.CitizenID, Age: '',
            IsDisabledOrChronic: "FALSE", Got10kDigitalWallet: "FALSE",
            Income_Salary: 0, Income_Agriculture: 0, Income_Business: 0, Income_Welfare: 0, Income_Other: 0, Income_Total: 0
          });
        }
        gState.householdMembers.forEach((member, index) => {
          member.MemberNo = index + 1;
          const row = document.createElement('tr');
          row.setAttribute('data-index', index);
          row.innerHTML = `
            <td>${member.MemberNo}</td>
            <td>${member.MemberName || 'N/A'}</td>
            <td>${member.Relation || 'N/A'}</td>
            <td>${member.CitizenID || 'N/A'}</td>
            <td>${member.Age || 'N/A'}</td>
            <td>${member.IsDisabledOrChronic === "TRUE" ? 'ใช่' : 'ไม่'}</td>
            <td>${member.Got10kDigitalWallet === "TRUE" ? 'ได้' : 'ไม่ได้'}</td>
            <td>${member.Income_Total || 0}</td>
            <td><button type="button" class="btn btn-sm btn-outline-primary edit-member-btn" data-index="${index}"><i class="bi bi-pencil"></i></button></td>
            <td>${member.Relation === 'นักเรียน' ? '' : `<button type="button" class="btn btn-sm btn-danger delete-row-btn" data-index="${index}"><i class="bi bi-trash"></i></button>`}</td>
          `;
          el.householdTbody.appendChild(row);
        });
        el.householdTbody.querySelectorAll('.edit-member-btn').forEach(btn => btn.addEventListener('click', (e) => editHouseholdMember(e.currentTarget.dataset.index)));
        el.householdTbody.querySelectorAll('.delete-row-btn').forEach(btn => btn.addEventListener('click', (e) => removeHouseholdMember(e.currentTarget.dataset.index)));
        calculateHouseholdIncome();
      }
      
      function addHouseholdMember() { editHouseholdMember(-1); }
      
      function editHouseholdMember(index) {
        const isNew = index == -1;
        const member = isNew ? { RecordID: gState.currentRecordId, MemberNo: gState.householdMembers.length + 1 } : gState.householdMembers[index];
        const isStudent = member.Relation === 'นักเรียน';
        Swal.fire({
          title: isNew ? 'เพิ่มสมาชิกใหม่' : `แก้ไขข้อมูล ${member.MemberName}`,
          html: `
            <div class="row text-start g-2">
              <div class="col-md-6"><label class="form-label">ชื่อ-นามสกุล</label><input id="swal-MemberName" class="form-control" value="${member.MemberName || ''}" ${isStudent ? 'readonly' : ''}></div>
              <div class="col-md-6"><label class="form-label">ความสัมพันธ์</label><input id="swal-Relation" class="form-control" value="${member.Relation || ''}" ${isStudent ? 'readonly' : ''}></div>
              <div class="col-md-6"><label class="form-label">เลข ปชช.</label><input id="swal-CitizenID" class="form-control" value="${member.CitizenID || ''}" ${isStudent ? 'readonly' : ''}></div>
              <div class="col-md-6"><label class="form-label">อายุ</label><input id="swal-Age" type="number" class="form-control" value="${member.Age || ''}"></div>
              <hr class="my-3"><h6 class="text-primary">รายได้ (ต่อเดือน)</h6>
              <div class="col-md-6"><label class="form-label">เงินเดือน</label><input id="swal-Income_Salary" type="number" class="form-control" value="${member.Income_Salary || 0}"></div>
              <div class="col-md-6"><label class="form-label">เกษตร</label><input id="swal-Income_Agriculture" type="number" class="form-control" value="${member.Income_Agriculture || 0}"></div>
              <div class="col-md-6"><label class="form-label">ธุรกิจ</label><input id="swal-Income_Business" type="number" class="form-control" value="${member.Income_Business || 0}"></div>
              <div class="col-md-6"><label class="form-label">สวัสดิการ</label><input id="swal-Income_Welfare" type="number" class="form-control" value="${member.Income_Welfare || 0}"></div>
              <div class="col-md-6"><label class="form-label">อื่นๆ</label><input id="swal-Income_Other" type="number" class="form-control" value="${member.Income_Other || 0}"></div>
              <hr class="my-3">
              <div class="col-md-6"><div class="form-check form-switch"><input id="swal-IsDisabledOrChronic" class="form-check-input" type="checkbox" ${member.IsDisabledOrChronic === "TRUE" ? 'checked' : ''}><label>พิการ/โรคเรื้อรัง</label></div></div>
              <div class="col-md-6"><div class="form-check form-switch"><input id="swal-Got10kDigitalWallet" class="form-check-input" type="checkbox" ${member.Got10kDigitalWallet === "TRUE" ? 'checked' : ''}><label>ได้เงิน 10k</label></div></div>
            </div>`,
          confirmButtonText: 'บันทึก', showCancelButton: true, cancelButtonText: 'ยกเลิก', focusConfirm: false,
          preConfirm: () => {
            const salary = parseFloat(document.getElementById('swal-Income_Salary').value) || 0;
            const aggr = parseFloat(document.getElementById('swal-Income_Agriculture').value) || 0;
            const biz = parseFloat(document.getElementById('swal-Income_Business').value) || 0;
            const welfare = parseFloat(document.getElementById('swal-Income_Welfare').value) || 0;
            const other = parseFloat(document.getElementById('swal-Income_Other').value) || 0;
            return {
              MemberName: document.getElementById('swal-MemberName').value,
              Relation: document.getElementById('swal-Relation').value,
              CitizenID: document.getElementById('swal-CitizenID').value,
              Age: document.getElementById('swal-Age').value,
          _Agriculture').value) || 0;
            const biz = parseFloat(document.getElementById('swal-Income_Business').value) || 0;
            const welfare = parseFloat(document.getElementById('swal-Income_Welfare').value) || 0;
            const other = parseFloat(document.getElementById('swal-Income_Other').value) || 0;
            return {
              MemberName: document.getElementById('swal-MemberName').value,
              Relation: document.getElementById('swal-Relation').value,
              CitizenID: document.getElementById('swal-CitizenID').value,
              Age: document.getElementById('swal-Age').value,
              Income_Salary: salary, Income_Agriculture: aggr, Income_Business: biz, Income_Welfare: welfare, Income_Other: other,
              Income_Total: salary + aggr + biz + welfare + other,
              IsDisabledOrChronic: document.getElementById('swal-IsDisabledOrChronic').checked ? "TRUE" : "FALSE",
              Got10kDigitalWallet: document.getElementById('swal-Got10kDigitalWallet').checked ? "TRUE" : "FALSE",
            };
          }
        }).then((result) => {
          if (result.isConfirmed) {
            const updatedMember = { ...member, ...result.value };
            if (isNew) { gState.householdMembers.push(updatedMember); }
            else { gState.householdMembers[index] = updatedMember; }
            trackChange('household_changed', true); 
            renderHouseholdTable(gState.householdMembers);
            saveToLocalStorage();
    _HouseholdIncome_PerCapita', perCapitaIncome.toFixed(2));
      }
      
      /*
       * ===================================================================
       * AUTO-SAVE, VALIDATION & CHANGE TRACKING
       * ===================================================================
       */

      function attachFormListeners() {
        const form = document.getElementById('visit-form');
        form.querySelectorAll('input[name], select[name], textarea[name]').forEach(el => {
          if (el.type === 'file') return;
          
          const eventType = (el.type === 'text' || el.type === 'number' || el.type === 'textarea') ? 'input' : 'change';
          
          el.addEventListener(eventType, (e) => {
            const fieldName = e.target.name;
            let value = (e.target.type === 'checkbox') ? (e.target.checked ? "TRUE" : "FALSE") : e.target.value;
            trackChange(fieldName, value);
            saveToLocalStorage();
          });
        });
      }
      
      function checkFormValidity() {
        const requiredFields = document.querySelectorAll('#visit-form .required-field');
        let missingFields = [];
        
        for (const el of requiredFields) {
          let isInvalid = false;
          
          const section = el.closest('.form-section');
          if (section && section.style.display === 'none') {
            continue;
          }
          const subsection = el.closest('.conditional-subsection');
          if (subsection && subsection.style.display === 'none') {
            continue;
          }

          if (el.type === 'checkbox') {
            if (!el.checked) isInvalid = true;
          } else {
            if (!el.value || el.value.trim() === '') isInvalid = true;
          }
          
          if (isInvalid) {
            missingFields.push(el.dataset.label || el.name);
          }
        }
        
        if (missingFields.length > 0) {
          gState.isFormValid = false;
          return missingFields;
        }
        
        gState.isFormValid = true;
        return [];
      }
      
      function trackChange(fieldName, newValue) {
        if (fieldName) {
          if (fieldName === 'household_changed') {
              gState.changesToPush['householdData'] = true;
          } else {
              const originalValue = gState.originalData.visitData ? gState.originalData.visitData[fieldName] : undefined;
              if (String(newValue) !== String(originalValue)) {
                gState.changesToPush[fieldName] = newValue;
              } else {
                delete gState.changesToPush[fieldName];
              }
          }
        }
        
        const changeCount = Object.keys(gState.changesToPush).length;
        const missingFields = checkFormValidity();
        const canSave = (changeCount > 0) && (missingFields.length === 0);
        
        el.saveBtn.disabled = !canSave;
        
        const spinner = el.saveBtn.querySelector('span');
        if (spinner) spinner.style.display = 'none';
        
        if (changeCount === 0) {
          el.saveBtn.innerHTML = `<i class="bi bi-cloud-arrow-up me-2"></i> บันทึก (0)`;
        } else if (missingFields.length > 0) {
          el.saveBtn.innerHTML = `<i class="bi bi-exclamation-triangle me-2"></i> ยังไม่ครบ (${missingFields.length})`;
          el.saveBtn.disabled = true;
        } else {
          el.saveBtn.innerHTML = `<i class="bi bi-cloud-arrow-up me-2"></i> บันทึก (${changeCount})`;
        }
      }
      
      function saveToLocalStorage() {
        const currentFormData = {
          studentMaster: gState.originalData.studentMaster,
          visitData: {},
          householdData: gState.householdMembers
        };
        const formElements = document.getElementById('visit-form').elements;
        Array.from(formElements).forEach(el => {
           if(el.name) {
             currentFormData.visitData[el.name] = (el.type === 'checkbox') ? (el.checked ? "TRUE" : "FALSE") : el.value;
           }
        });
        localStorage.setItem(`visit_${gState.currentRecordId}`, JSON.stringify(currentFormData));
      }
      
      function loadFromLocalStorage() {
          const data = localStorage.getItem(`visit_${gState.currentRecordId}`);
          return data ? JSON.parse(data) : null;
      }
      
      /*
       * ===================================================================
       * SAVE TO GOOGLE SHEETS
       * ===================================================================
       */
      
      async function handleSaveToSheets() {
        const missingFields = checkFormValidity();
        if (!gState.isFormValid || missingFields.length > 0) {
          Swal.fire(
            'ข้อมูลยังไม่ครบ!',
            'กรุณากรอกข้อมูลที่จำเป็นให้ครบถ้วน: <br><ul class="text-start">' + 
            missingFields.map(f => `<li>${f}</li>`).join('') + '</ul>',
            'error'
          );
          trackChange(null, null);
          return; 
        }
        
        el.saveBtn.disabled = true;
        el.saveBtn.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> กำลังบันทึก...`;
        
        try {
          const dataToSave = {};
          const formElements = document.getElementById('visit-form').elements;
          Array.from(formElements).forEach(el => {
            if(el.name) {
              dataToSave[el.name] = (el.type === 'checkbox') ? (el.checked ? "TRUE" : "FALSE") : el.value;
            }
          });
          dataToSave["RecordID"] = gState.currentRecordId;
          dataToSave["UpdatedBy"] = gState.currentUser.Email;
          
          let method = 'POST';
          let url = `${SHEETDB_API_URL}?sheet=VisitData`;
          
          if (gState.originalData.visitData) {
            method = 'PATCH';
            url = `${SHEETDB_API_URL}/RecordID/${gState.currentRecordId}?sheet=VisitData`;
          }
          
          setLoading(true, 'กำลังบันทึกข้อมูลหลัก...');
          const saveVisitData = await fetch(url, {
              method: method,
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ data: dataToSave })
          });
          if (!saveVisitData.ok) throw new Error("บันทึกข้อมูลหลักไม่สำเร็จ");
          
          if (gState.changesToPush['householdData']) {
            setLoading(true, 'กำลังลบข้อมูลครัวเรือนเก่า...');
            const deleteUrl = `${SHEETDB_API_URL}/RecordID/${gState.currentRecordId}?sheet=HouseholdMembers`;
            const deleteHousehold = await fetch(deleteUrl, { method: 'DELETE' });
            
            setLoading(true, 'กำลังบันทึกข้อมูลครัวเรือน...');
            const householdToSave = gState.householdMembers.map(member => ({
              ...member,
              RecordID: gState.currentRecordId
            }));
            
            const addHousehold = await fetch(`${SHEETDB_API_URL}?sheet=HouseholdMembers`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ data: householdToSave })
            });
            if (!addHousehold.ok) throw new Error("บันทึกข้อมูลครัวเรือนไม่สำเร็จ");
          }
          
          onSaveSuccess();

        } catch(error) {
          handleError(error);
        }
      }
      
      function onSaveSuccess() {
        setLoading(false);
        Swal.fire({
          title: 'บันทึกสำเร็จ!', icon: 'success', timer: 1500, showConfirmButton: false
        });
        gState.changesToPush = {};
        const data = loadFromLocalStorage();
        gState.originalData = JSON.parse(JSON.stringify(data));
Z
        checkFormValidity();
        el.saveBtn.disabled = true;
        el.saveBtn.innerHTML = `<i class="bi bi-cloud-arrow-up me-2"></i> บันทึก (0)`;
      }

      /*
       * ===================================================================
       * UTILITIES
       * ===================================================================
       */
      
      function setLoading(isLoading, message = 'กำลังโหลด...') {
        gState.isLoading = isLoading;
        if(SCREENS.loading) {
          SCREENS.loading.querySelector('p').textContent = message;
          SCREENS.loading.style.display = isLoading ? 'flex' : 'none';
        }
      }
      
      function handleError(error) {
        setLoading(false);
        Swal.fire('เกิดข้อผิดพลาด', error.message || error, 'error');
        if(el.loginBtn) el.loginBtn.disabled = false;
        if(el.saveBtn) {
          trackChange(null, null);
        }
      }
      
    </script>
    
  </body>
</html>
