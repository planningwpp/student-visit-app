<script>
  /*
   * ===================================================================
   * GLOBAL VARIABLES
   * ===================================================================
   */
  
  // (สำคัญ!) 1. ใส่ API ของ SheetDB (ที่คุณใช้อยู่)
  const SHEETDB_API_URL = "https://sheetdb.io/api/v1/bczb66wme054a"; 
  
  // (สำคัญ!) 2. ไปที่ cloudinary.com แล้วเอา "Cloud Name" มาใส่
  const CLOUDINARY_CLOUD_NAME = "dzzdmlei5"; // <--- คุณใส่ Cloud Name ของคุณไว้แล้ว
  const CLOUDINARY_UPLOAD_PRESET = "ml_default";
  const CLOUDINARY_URL = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`;

  const gState = {
    currentUser: null,
    selectedStudentId: null,
    selectedStudentName: null,
    currentRecordId: null,
    originalData: {},
    changesToPush: {},
    householdMembers: [],
    isLoading: false,
  };
  
  // (อัปเดต) เราจะประกาศตัวแปร DOM ที่นี่ แต่จะกำหนดค่าทีหลัง
  let SCREENS = {};
  let el = {};

  /*
   * ===================================================================
   * (อัปเดต) ENTRY POINT (เริ่มต้นระบบ)
   * ===================================================================
   */
  document.addEventListener("DOMContentLoaded", () => {
    
    // (สำคัญ!) กำหนดค่าตัวแปร DOM ที่นี่ หลังจากที่หน้าเว็บโหลดเสร็จ
    SCREENS = {
      loading: document.getElementById('loading-screen'),
      login: document.getElementById('login-screen'),
      selection: document.getElementById('student-selection-screen'),
      form: document.getElementById('main-form-screen')
    };
    
    el = {
      loginForm: document.getElementById('manual-login-form'),
      loginEmailInput: document.getElementById('login-email'),
      loginPasswordInput: document.getElementById('login-password'),
      loginBtn: document.getElementById('login-btn'),
      loginErrorMessage: document.getElementById('login-error-message'),
      logoutBtn: document.getElementById('logout-btn'),
      userNameDisplay: document.getElementById('user-name-display'),
      classSelect: document.getElementById('class-select'),
      studentSelect: document.getElementById('student-select'),
      semesterSelect: document.getElementById('semester-select'),
      yearSelect: document.getElementById('year-select'),
      startFormBtn: document.getElementById('start-form-btn'),
      backBtn: document.getElementById('back-to-selection-btn'),
      saveBtn: document.getElementById('save-to-sheets-btn'),
      studentNameHeader: document.getElementById('student-name-header'),
      sidebarLinks: document.querySelectorAll('#form-sidebar .nav-link'),
      formSections: document.querySelectorAll('.form-section'),
      gpsBtn: document.getElementById('get-gps-btn'),
      livesWithSelect: document.getElementById('Q1_LivesWith'),
      q4Content: document.getElementById('q4-content'),
      q3_1_Status: document.querySelectorAll('input[name="Q3_1_DependencyStatus"]'),
      q3_1_SubOptions: document.getElementById('q3-1-sub-options'),
      q3_4_Status: document.querySelectorAll('input[name="Q3_4_AgricultureStatus"]'),
      q3_4_SubOptions: document.getElementById('q3-4-sub-options'),
      householdTbody: document.getElementById('household-member-list'),
      addMemberBtn: document.getElementById('add-member-btn'),
      totalMembersInput: document.getElementById('Q2_TotalMembers'),
      totalIncomeInput: document.getElementById('Q2_HouseholdIncome_Total'),
      perCapitaIncomeInput: document.getElementById('Q2_HouseholdIncome_PerCapita'),
      progressBar: document.getElementById('progress-bar')
    };
    
    // แสดงหน้า Login ทันที (ซ่อน "กำลังเริ่มต้น...")
    showScreen('login');
    
    // ผูก Event Listener
    bindEventListeners();
    
    // ตั้งค่าปีการศึกษาอัตโนมัติ
    el.yearSelect.value = new Date().getFullYear() + 543;
  });
  
  /*
   * ===================================================================
   * (ใหม่) API HELPER (สำหรับ SheetDB)
   * ===================================================================
   */
   
  /**
   * (ใหม่) ฟังก์ชันกลางสำหรับเรียก SheetDB API (แบบ GET)
   */
  async function callSheetDB_GET(url, loadingMessage = 'กำลังโหลด...') {
    setLoading(true, loadingMessage);
    try {
      const response = await fetch(url);
      if (!response.ok) {
        throw new Error(`NetworkError: การเชื่อมต่อล้มเหลว (HTTP ${response.status})`);
      }
      const data = await response.json();
      setLoading(false);
      return data;
    } catch (error) {
      handleError(error);
      throw error;
    }
  }

  /**
   * (ใหม่) ฟังก์ชันกลางสำหรับเรียก SheetDB API (แบบ POST/PATCH/DELETE)
   */
  async function callSheetDB_MUTATE(url, method = 'POST', payload, loadingMessage = 'กำลังบันทึก...') {
    setLoading(true, loadingMessage);
    try {
      const response = await fetch(url, {
        method: method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ data: payload })
      });
      if (!response.ok) {
        throw new Error(`NetworkError: การเชื่อมต่อล้มเหลว (HTTP ${response.status})`);
      }
      const data = await response.json();
      setLoading(false);
      return data;
    } catch (error) {
      handleError(error);
      throw error;
    }
  }

  /*
   * ===================================================================
   * (อัปเดต) LOGIN FLOW (สำหรับ SheetDB)
   * ===================================================================
   */
  
  async function handleManualLogin(event) {
    event.preventDefault();
    el.loginBtn.disabled = true;
    el.loginErrorMessage.style.display = 'none';

    try {
      const email = el.loginEmailInput.value;
      const password = el.loginPasswordInput.value;
      const url = `${SHEETDB_API_URL}/search?Email=${encodeURIComponent(email)}&Password=${encodeURIComponent(password)}&sheet=Users`;
      
      const data = await callSheetDB_GET(url, "กำลังตรวจสอบข้อมูล...");
      
      if (data && data.length > 0) {
        handleLoginSuccess(data[0]); // ส่งข้อมูล User (แถวแรกที่เจอ)
      } else {
        handleLoginFailure("อีเมล หรือ รหัสผ่านไม่ถูกต้อง");
      }
    } catch (error) {
      handleLoginFailure(error.message);
    }
  }

  async function handleLoginSuccess(user) {
    if (user && user.Email) { 
      gState.currentUser = user; 
      el.userNameDisplay.textContent = user.TeacherName;
      showScreen('selection');
      
      try {
        const allStudents = await callSheetDB_GET(`${SHEETDB_API_URL}?sheet=Students`, "กำลังโหลดข้อมูลชั้นเรียน...");
        
        const allClassesSet = new Set(allStudents.map(s => s.Class.trim()));
        let filteredClasses = Array.from(allClassesSet).sort();

        if (user.Role !== 'Admin' && user.AssignedClasses && user.AssignedClasses.trim() !== "") {
          const allowedClassesSet = new Set(user.AssignedClasses.split(',').map(c => c.trim().toLowerCase()));
          filteredClasses = filteredClasses.filter(c => allowedClassesSet.has(c.toLowerCase()));
        }
        
        populateClassDropdown(filteredClasses);
        
      } catch (error) {
        handleError(error);
      }
        
    } else {
      handleLoginFailure("ข้อมูลผู้ใช้ไม่ถูกต้อง (ไม่พบ Email)");
    }
  }

  function handleLoginFailure(error) {
    setLoading(false);
    gState.currentUser = null;
    showScreen('login');
    el.loginBtn.disabled = false;
    el.loginErrorMessage.textContent = String(error);
    el.loginErrorMessage.style.display = 'block';
  }
  
  function handleLogout() {
     gState.currentUser = null;
     el.loginEmailInput.value = '';
     el.loginPasswordInput.value = '';
     el.loginErrorMessage.style.display = 'none';
     showScreen('login');
  }
  
  function showScreen(screenId) {
    if (!SCREENS.loading) { console.error("SCREENS object not initialized!"); return; }
    Object.values(SCREENS).forEach(screen => {
      if(screen) screen.style.display = 'none';
    });
    if (SCREENS[screenId]) {
      SCREENS[screenId].style.display = 'block';
    }
  }

  /*
   * ===================================================================
   * (อัปเดต) STUDENT SELECTION (สำหรับ SheetDB)
   * ===================================================================
   */

  function populateClassDropdown(classes) {
    el.classSelect.innerHTML = '<option value="">-- กรุณาเลือก --</option>';
    classes.forEach(className => {
      const option = new Option(className, className);
      el.classSelect.add(option);
    });
  }

  async function handleClassChange() {
    const className = el.classSelect.value;
    if (!className) {
      el.studentSelect.innerHTML = '<option value="">-- กรุณาเลือกระดับชั้นก่อน --</option>';
      el.studentSelect.disabled = true;
      el.startFormBtn.disabled = true;
      return;
    }
    el.studentSelect.disabled = true;

    try {
      const url = `${SHEETDB_API_URL}/search?Class=${encodeURIComponent(className)}&sheet=Students`;
      const students = await callSheetDB_GET(url, "กำลังโหลดรายชื่อนักเรียน...");
      
      students.sort((a, b) => parseInt(a.StudentNumber, 10) - parseInt(b.StudentNumber, 10));
      populateStudentDropdown(students);
      
    } catch (error) {
      handleError(error);
    }
  }
  
  function populateStudentDropdown(students) {
    el.studentSelect.innerHTML = '<option value="">-- กรุณาเลือก --</option>';
    students.forEach(student => {
      const name = `${student.Prefix} ${student.FirstName} ${student.LastName} (เลขที่ ${student.StudentNumber})`;
      const option = new Option(name, student.StudentID);
      el.studentSelect.add(option);
    });
    el.studentSelect.disabled = false;
    validateStartButton();
  }
  
  function validateStartButton() {
    const hasClass = el.classSelect.value;
    const hasStudent = el.studentSelect.value;
    const hasSemester = el.semesterSelect.value;
    const hasYear = el.yearSelect.value;
    el.startFormBtn.disabled = !(hasClass && hasStudent && hasSemester && hasYear);
  }

  /*
   * ===================================================================
   * (อัปเดต) FORM LOADING & DISPLAY (สำหรับ SheetDB)
   * ===================================================================
   */

  async function handleStartForm() {
    gState.selectedStudentId = el.studentSelect.value;
    gState.selectedStudentName = el.studentSelect.options[el.studentSelect.selectedIndex].text;
    const semester = el.semesterSelect.value;
    const year = el.yearSelect.value;
    gState.currentRecordId = `${gState.selectedStudentId}_${semester}_${year}`;
    el.studentNameHeader.textContent = `${gState.selectedStudentName} (ภาคเรียน ${semester}/${year})`;
    
    const localData = loadFromLocalStorage();
    if (localData) {
      setLoading(true, 'กำลังโหลดข้อมูลที่บันทึกไว้...');
      gState.originalData = JSON.parse(JSON.stringify(localData));
      prefillForm(localData.studentMaster, localData.visitData);
      renderHouseholdTable(localData.householdData);
      showScreen('form');
      setLoading(false);
      attachFormListeners();
    } else {
      setLoading(true, 'กำลังโหลดข้อมูลนักเรียน...');
      try {
        const studentUrl = `${SHEETDB_API_URL}/search?StudentID=${gState.selectedStudentId}&sheet=Students`;
        const visitUrl = `${SHEETDB_API_URL}/search?RecordID=${gState.currentRecordId}&sheet=VisitData`;
        const householdUrl = `${SHEETDB_API_URL}/search?RecordID=${gState.currentRecordId}&sheet=HouseholdMembers`;

        const [studentRes, visitRes, householdRes] = await Promise.all([
          fetch(studentUrl),
          fetch(visitUrl),
          fetch(householdUrl)
        ]);

        const studentData = await studentRes.json();
        const visitData = await visitRes.json();
        const householdData = await householdRes.json();
        
        const data = {
          studentMaster: (studentData.length > 0) ? studentData[0] : null,
          visitData: (visitData.length > 0) ? visitData[0] : null,
          householdData: householdData
        };
        
        loadStudentDataSuccess(data);
      } catch(error) {
        handleError(error);
      }
    }
  }

  function loadStudentDataSuccess(data) {
    gState.originalData = JSON.parse(JSON.stringify(data));
    prefillForm(data.studentMaster, data.visitData);
    renderHouseholdTable(data.householdData || []);
    showScreen('form');
    showSection('section-1');
    updateProgressBar();
    attachFormListeners();
    setLoading(false);
  }
  
  function prefillForm(master, visit) {
    if (!master) {
      handleError({ message: "ไม่พบข้อมูลหลักของนักเรียน (Student Master Data)" });
      return;
    }
    document.getElementById('s1-name').textContent = `${master.Prefix || ''} ${master.FirstName} ${master.LastName}`;
    document.getElementById('s1-class').textContent = master.Class;
    document.getElementById('s1-citizenid').textContent = master.CitizenID || 'N/A';
    document.getElementById('Q1_GuardianFirstName').value = (visit && visit.Q1_GuardianFirstName) || master.DefaultGuardianName || '';
    document.getElementById('Q1_GuardianPhone').value = (visit && visit.Q1_GuardianPhone) || master.DefaultGuardianPhone || '';

    if (visit) {
      const formElements = document.getElementById('visit-form').elements;
      for (const key in visit) {
        const el = formElements[key];
        if (el) {
          if (el.type === 'checkbox') {
            el.checked = (visit[key] === "TRUE");
          } else if (el.type === 'radio') {
            const radioToSelect = document.querySelector(`input[name="${key}"][value="${visit[key]}"]`);
            if (radioToSelect) radioToSelect.checked = true;
          } else if (el.type === 'hidden' && (key === 'Q1_PhotoURL' || key === 'Q7_Photo1_URL' || key === 'Q7_Photo2_URL')) {
            el.value = visit[key];
            if (visit[key]) {
              const previewImg = document.getElementById(`preview_${key}`);
              if (previewImg) {
                previewImg.src = visit[key];
                previewImg.style.display = 'block';
              }
            }
          } else {
            if (el.name !== 'Q6_Addr_Village' || (el.name === 'Q6_Addr_Village' && visit[key])) {
               el.value = visit[key];
            }
          }
          if(el.name === 'Q1_LivesWith' || el.name === 'Q3_1_DependencyStatus' || el.name === 'Q3_4_AgricultureStatus') {
             el.dispatchEvent(new Event('change'));
          }
        }
      }
    }
  }
  
  function handleBackToSelection() {
    if (Object.keys(gState.changesToPush).length > 0) {
      Swal.fire({
        title: 'ยังไม่ไดบันทึก!',
        text: `คุณมีการเปลี่ยนแปลง ${Object.keys(gState.changesToPush).length} รายการที่ยังไม่ได้บันทึก, คุณต้องการออกโดยไม่บันทึกหรือไม่?`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'ใช่, ออกเลย',
        cancelButtonText: 'ยกเลิก'
      }).then((result) => {
        if (result.isConfirmed) {
          resetFormState();
          showScreen('selection');
        }
      });
    } else {
      resetFormState();
      showScreen('selection');
    }
  }

  function resetFormState() {
    localStorage.removeItem(`visit_${gState.currentRecordId}`);
    document.getElementById('visit-form').reset();
    document.querySelectorAll('.img-thumbnail').forEach(img => {
      img.src = '';
      img.style.display = 'none';
    });
    gState.currentRecordId = null;
    gState.selectedStudentId = null;
    gState.selectedStudentName = null;
    gState.originalData = {};
    gState.changesToPush = {};
    gState.householdMembers = [];
    el.householdTbody.innerHTML = '';
    el.studentSelect.value = '';
    el.saveBtn.textContent = 'บันทึก (0)';
    el.saveBtn.disabled = true;
    updateProgressBar(0);
  }
  
  /*
   * ===================================================================
   * FORM NAVIGATION & INTERACTIVITY
   * ===================================================================
   */

  function bindEventListeners() {
    el.loginForm.addEventListener('submit', handleManualLogin);
    el.logoutBtn.addEventListener('click', handleLogout);
    el.classSelect.addEventListener('change', handleClassChange);
    el.studentSelect.addEventListener('change', validateStartButton);
    el.semesterSelect.addEventListener('input', validateStartButton);
    el.yearSelect.addEventListener('input', validateStartButton);
    el.startFormBtn.addEventListener('click', handleStartForm);
    el.backBtn.addEventListener('click', handleBackToSelection);
    el.saveBtn.addEventListener('click', handleSaveToSheets);
    el.gpsBtn.addEventListener('click', handleGPSButton);
    el.sidebarLinks.forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const sectionId = e.currentTarget.getAttribute('data-section');
        showSection(sectionId);
      });
    });
    el.livesWithSelect.addEventListener('change', (e) => {
      const show = e.target.value === 'ครัวเรือนสถาบัน';
      el.q4Content.style.display = show ? 'block' : 'none';
      document.querySelector(`a[href="#section-4"]`).style.display = show ? 'block' : 'none';
    });
    el.q3_1_Status.forEach(radio => radio.addEventListener('change', (e) => {
       el.q3_1_SubOptions.style.display = (e.target.value === 'มี') ? 'block' : 'none';
    }));
    el.q3_4_Status.forEach(radio => radio.addEventListener('change', (e) => {
       el.q3_4_SubOptions.style.display = (e.target.value === 'ทำ') ? 'block' : 'none';
    }));
    el.addMemberBtn.addEventListener('click', addHouseholdMember);
    document.querySelectorAll('.file-upload-input').forEach(input => {
      input.addEventListener('change', handleFileUpload);
    });
  }
  
  function showSection(sectionId) {
    el.formSections.forEach(section => {
      section.classList.toggle('active', section.id === sectionId);
    });
    el.sidebarLinks.forEach(link => {
      link.classList.toggle('active', link.getAttribute('data-section') === sectionId);
    });
    window.scrollTo(0, 0);
  }
  
  function handleGPSButton() {
    if (!navigator.geolocation) {
      Swal.fire('ไม่รองรับ', 'เบราว์เซอร์ของคุณไม่รองรับ Geolocation', 'error'); return;
    }
    setLoading(true, 'กำลังดึงพิกัด...');
    navigator.geolocation.getCurrentPosition(
      (position) => {
        setLoading(false);
        const lat = position.coords.latitude.toFixed(6);
        const lon = position.coords.longitude.toFixed(6);
        document.getElementById('Q6_Addr_Latitude').value = lat;
        document.getElementById('Q6_Addr_Longitude').value = lon;
        trackChange('Q6_Addr_Latitude', lat);
        trackChange('Q6_Addr_Longitude', lon);
        saveToLocalStorage();
      },
      (err) => { setLoading(false); Swal.fire('เกิดข้อผิดพลาด', `ไม่สามารถดึงพิกัดได้: ${err.message}`, 'error'); }
    );
  }
  
  /**
   * (ใหม่) handleFileUpload (สำหรับ Cloudinary)
   */
  async function handleFileUpload(event) {
    const fileInput = event.target;
    const file = fileInput.files[0]; if (!file) return;
    const hiddenInputId = fileInput.dataset.targetHidden;
    const hiddenInput = document.getElementById(hiddenInputId);
    const previewImg = document.getElementById(`preview_${hiddenInputId}`);
    
    previewImg.style.display = 'block';
    previewImg.src = 'https://i.gifer.com/origin/34/34338d26023e5515f6cc8969aa027bca_w200.gif';
    setLoading(true, 'กำลังอัปโหลดรูปภาพ...');
    
    try {
      const formData = new FormData();
      formData.append('file', file);
      formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);

      const response = await fetch(CLOUDINARY_URL, {
        method: 'POST',
        body: formData
      });
      
      if (!response.ok) throw new Error('Cloudinary upload failed');
      
      const data = await response.json();
      const secureUrl = data.secure_url; 
      
      setLoading(false);
      previewImg.src = secureUrl;
      hiddenInput.value = secureUrl;
      trackChange(hiddenInput.name, secureUrl);
      saveToLocalStorage();
      
    } catch (error) {
      handleError(error);
      previewImg.style.display = 'none';
    }
  }
  
  function updateProgressBar(percent = null) {
    let p = 0; if (percent !== null) { p = percent; }
    el.progressBar.style.width = `${p}%`;
    el.progressBar.textContent = `${p}%`;
  }

  /*
   * ===================================================================
   * HOUSEHOLD MEMBERS
   * ===================================================================
   */

  function renderHouseholdTable(members = []) {
    gState.householdMembers = members;
    el.householdTbody.innerHTML = '';
    if (gState.householdMembers.length === 0 && gState.originalData.studentMaster) {
      const studentMaster = gState.originalData.studentMaster;
      gState.householdMembers.push({
        RecordID: gState.currentRecordId, MemberNo: 1,
        MemberName: `${studentMaster.FirstName} ${studentMaster.LastName}`,
        Relation: 'นักเรียน', CitizenID: studentMaster.CitizenID, Age: '',
        IsDisabledOrChronic: "FALSE", Got10kDigitalWallet: "FALSE",
        Income_Salary: 0, Income_Agriculture: 0, Income_Business: 0, Income_Welfare: 0, Income_Other: 0, Income_Total: 0
      });
    }
    gState.householdMembers.forEach((member, index) => {
      member.MemberNo = index + 1;
      const row = document.createElement('tr');
      row.setAttribute('data-index', index);
      row.innerHTML = `
        <td>${member.MemberNo}</td>
        <td>${member.MemberName || 'N/A'}</td>
        <td>${member.Relation || 'N/A'}</td>
        <td>${member.CitizenID || 'N/A'}</td>
        <td>${member.Age || 'N/A'}</td>
        <td>${member.IsDisabledOrChronic === "TRUE" ? 'ใช่' : 'ไม่'}</td>
        <td>${member.Got10kDigitalWallet === "TRUE" ? 'ได้' : 'ไม่ได้'}</td>
        <td>${member.Income_Total || 0}</td>
        <td><button type="button" class="btn btn-sm btn-outline-primary edit-member-btn" data-index="${index}"><i class="bi bi-pencil"></i></button></td>
        <td>${member.Relation === 'นักเรียน' ? '' : `<button type="button" class="btn btn-sm btn-danger delete-row-btn" data-index="${index}"><i class="bi bi-trash"></i></button>`}</td>
      `;
      el.householdTbody.appendChild(row);
    });
    el.householdTbody.querySelectorAll('.edit-member-btn').forEach(btn => btn.addEventListener('click', (e) => editHouseholdMember(e.currentTarget.dataset.index)));
    el.householdTbody.querySelectorAll('.delete-row-btn').forEach(btn => btn.addEventListener('click', (e) => removeHouseholdMember(e.currentTarget.dataset.index)));
    calculateHouseholdIncome();
  }
  
  function addHouseholdMember() { editHouseholdMember(-1); }
  
  function editHouseholdMember(index) {
    const isNew = index == -1;
    const member = isNew ? { RecordID: gState.currentRecordId, MemberNo: gState.householdMembers.length + 1 } : gState.householdMembers[index];
    const isStudent = member.Relation === 'นักเรียน';
    Swal.fire({
      title: isNew ? 'เพิ่มสมาชิกใหม่' : `แก้ไขข้อมูล ${member.MemberName}`,
      html: `
        <div class="row text-start g-2">
          <div class="col-md-6"><label class="form-label">ชื่อ-นามสกุล</label><input id="swal-MemberName" class="form-control" value="${member.MemberName || ''}" ${isStudent ? 'readonly' : ''}></div>
          <div class="col-md-6"><label class="form-label">ความสัมพันธ์</label><input id="swal-Relation" class="form-control" value="${member.Relation || ''}" ${isStudent ? 'readonly' : ''}></div>
          <div class="col-md-6"><label class="form-label">เลข ปชช.</label><input id="swal-CitizenID" class="form-control" value="${member.CitizenID || ''}" ${isStudent ? 'readonly' : ''}></div>
          <div class="col-md-6"><label class="form-label">อายุ</label><input id="swal-Age" type="number" class="form-control" value="${member.Age || ''}"></div>
          <hr class="my-3"><h6 class="text-primary">รายได้ (ต่อเดือน)</h6>
          <div class="col-md-6"><label class="form-label">เงินเดือน</label><input id="swal-Income_Salary" type="number" class="form-control" value="${member.Income_Salary || 0}"></div>
          <div class="col-md-6"><label class="form-label">เกษตร</label><input id="swal-Income_Agriculture" type="number" class="form-control" value="${member.Income_Agriculture || 0}"></div>
          <div class="col-md-6"><label class="form-label">ธุรกิจ</label><input id="swal-Income_Business" type="number" class="form-control" value="${member.Income_Business || 0}"></div>
          <div class="col-md-6"><label class="form-label">สวัสดิการ</label><input id="swal-Income_Welfare" type="number" class="form-control" value="${member.Income_Welfare || 0}"></div>
          <div class="col-md-6"><label class="form-label">อื่นๆ</label><input id="swal-Income_Other" type="number" class="form-control" value="${member.Income_Other || 0}"></div>
          <hr class="my-3">
          <div class="col-md-6"><div class="form-check form-switch"><input id="swal-IsDisabledOrChronic" class="form-check-input" type="checkbox" ${member.IsDisabledOrChronic === "TRUE" ? 'checked' : ''}><label>พิการ/โรคเรื้อรัง</label></div></div>
          <div class="col-md-6"><div class="form-check form-switch"><input id="swal-Got10kDigitalWallet" class="form-check-input" type="checkbox" ${member.Got10kDigitalWallet === "TRUE" ? 'checked' : ''}><label>ได้เงิน 10k</label></div></div>
        </div>`,
      confirmButtonText: 'บันทึก', showCancelButton: true, cancelButtonText: 'ยกเลิก', focusConfirm: false,
      preConfirm: () => {
        const salary = parseFloat(document.getElementById('swal-Income_Salary').value) || 0;
        const aggr = parseFloat(document.getElementById('swal-Income_Agriculture').value) || 0;
        const biz = parseFloat(document.getElementById('swal-Income_Business').value) || 0;
        const welfare = parseFloat(document.getElementById('swal-Income_Welfare').value) || 0;
        const other = parseFloat(document.getElementById('swal-Income_Other').value) || 0;
        return {
          MemberName: document.getElementById('swal-MemberName').value,
          Relation: document.getElementById('swal-Relation').value,
          CitizenID: document.getElementById('swal-CitizenID').value,
          Age: document.getElementById('swal-Age').value,
          Income_Salary: salary, Income_Agriculture: aggr, Income_Business: biz, Income_Welfare: welfare, Income_Other: other,
          Income_Total: salary + aggr + biz + welfare + other,
          IsDisabledOrChronic: document.getElementById('swal-IsDisabledOrChronic').checked ? "TRUE" : "FALSE",
          Got10kDigitalWallet: document.getElementById('swal-Got10kDigitalWallet').checked ? "TRUE" : "FALSE",
        };
      }
    }).then((result) => {
      if (result.isConfirmed) {
        const updatedMember = { ...member, ...result.value };
        if (isNew) { gState.householdMembers.push(updatedMember); }
        else { gState.householdMembers[index] = updatedMember; }
        trackChange('household_changed', true); 
        renderHouseholdTable(gState.householdMembers);
        saveToLocalStorage();
      }
    });
  }
  
  function removeHouseholdMember(index) {
    if (gState.householdMembers[index].Relation === 'นักเรียน') {
      Swal.fire('ลบไม่ได้', 'ไม่สามารถลบข้อมูลของตัวนักเรียนได้', 'error'); return;
    }
    Swal.fire({
      title: 'ยืนยันการลบ', text: `คุณต้องการลบ ${gState.householdMembers[index].MemberName} ออกจากครัวเรือนใช่หรือไม่?`,
      icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33',
      confirmButtonText: 'ใช่, ลบเลย', cancelButtonText: 'ยกเลิก'
    }).then((result) => {
      if (result.isConfirmed) {
        gState.householdMembers.splice(index, 1);
        trackChange('household_changed', true);
        renderHouseholdTable(gState.householdMembers);
        saveToLocalStorage();
      }
    });
  }
  
  function calculateHouseholdIncome() {
    const totalMembers = gState.householdMembers.length;
    const totalIncome = gState.householdMembers.reduce((sum, m) => sum + (parseFloat(m.Income_Total) || 0), 0);
    const perCapitaIncome = totalMembers > 0 ? (totalIncome / totalMembers) : 0;
    el.totalMembersInput.value = totalMembers;
    el.totalIncomeInput.value = totalIncome;
    el.perCapitaIncomeInput.value = perCapitaIncome.toFixed(2);
    trackChange('Q2_TotalMembers', totalMembers);
    trackChange('Q2_HouseholdIncome_Total', totalIncome);
    trackChange('Q2_HouseholdIncome_PerCapita', perCapitaIncome.toFixed(2));
  }
  
  /*
   * ===================================================================
   * AUTO-SAVE & DELTA CHANGE TRACKING
   * ===================================================================
   */

  function attachFormListeners() {
    const form = document.getElementById('visit-form');
    form.querySelectorAll('input[name], select[name], textarea[name]').forEach(el => {
      if (el.type === 'file') return;
      el.addEventListener('change', (e) => {
        const fieldName = e.target.name;
        let value = (e.target.type === 'checkbox') ? (e.target.checked ? "TRUE" : "FALSE") : e.target.value;
        trackChange(fieldName, value);
        saveToLocalStorage();
      });
    });
  }
  
  function trackChange(fieldName, newValue) {
    if (!fieldName) return;
    if (fieldName === 'household_changed') {
        gState.changesToPush['householdData'] = true;
    } else {
        const originalValue = gState.originalData.visitData ? gState.originalData.visitData[fieldName] : undefined;
        if (String(newValue) !== String(originalValue)) {
          gState.changesToPush[fieldName] = newValue;
        } else {
          delete gState.changesToPush[fieldName];
        }
    }
    const changeCount = Object.keys(gState.changesToPush).length;
    el.saveBtn.disabled = (changeCount === 0);
    el.saveBtn.querySelector('i').style.display = 'inline-block';
    const spinner = el.saveBtn.querySelector('span');
    if (spinner) spinner.style.display = 'none';
    el.saveBtn.innerHTML = `<i class="bi bi-cloud-arrow-up me-2"></i> บันทึก (${changeCount})`;
  }
  
  function saveToLocalStorage() {
    const currentFormData = {
      studentMaster: gState.originalData.studentMaster,
      visitData: {},
      householdData: gState.householdMembers
    };
    const formElements = document.getElementById('visit-form').elements;
    Array.from(formElements).forEach(el => {
       if(el.name) {
         currentFormData.visitData[el.name] = (el.type === 'checkbox') ? (el.checked ? "TRUE" : "FALSE") : el.value;
       }
    });
    localStorage.setItem(`visit_${gState.currentRecordId}`, JSON.stringify(currentFormData));
  }
  
  function loadFromLocalStorage() {
      const data = localStorage.getItem(`visit_${gState.currentRecordId}`);
      return data ? JSON.parse(data) : null;
  }
  
  /*
   * ===================================================================
   * (ใหม่) SAVE TO GOOGLE SHEETS (สำหรับ SheetDB)
   * ===================================================================
   */
  
  async function handleSaveToSheets() {
    el.saveBtn.disabled = true;
    el.saveBtn.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> กำลังบันทึก...`;
    
    try {
      // 1. รวบรวมข้อมูล VisitData
      const dataToSave = {};
      const formElements = document.getElementById('visit-form').elements;
      Array.from(formElements).forEach(el => {
        if(el.name) {
          dataToSave[el.name] = (el.type === 'checkbox') ? (el.checked ? "TRUE" : "FALSE") : el.value;
        }
      });
      dataToSave["RecordID"] = gState.currentRecordId; // เพิ่ม Key
      dataToSave["UpdatedBy"] = gState.currentUser.Email;
      
      let method = 'POST'; // สร้างใหม่
      let url = `${SHEETDB_API_URL}?sheet=VisitData`;
      
      // 2. ตรวจสอบว่ามีข้อมูลนี้อยู่แล้วหรือไม่ (เพื่อ Update)
      if (gState.originalData.visitData) {
        method = 'PATCH'; // อัปเดตทับ
        url = `${SHEETDB_API_URL}/RecordID/${gState.currentRecordId}?sheet=VisitData`;
      }
      
      // 3. บันทึก VisitData
      await callSheetDB_MUTATE(url, method, dataToSave, "กำลังบันทึกข้อมูลหลัก...");
      
      // 4. บันทึก HouseholdMembers (ลบของเก่า -> เพิ่มของใหม่)
      if (gState.changesToPush['householdData']) {
        setLoading(true, 'กำลังลบข้อมูลครัวเรือนเก่า...');
        const deleteUrl = `${SHEETDB_API_URL}/RecordID/${gState.currentRecordId}?sheet=HouseholdMembers`;
        const deleteHousehold = await fetch(deleteUrl, { method: 'DELETE' });
        
        setLoading(true, 'กำลังบันทึกข้อมูลครัวเรือน...');
        const householdToSave = gState.householdMembers.map(member => ({
          ...member,
          RecordID: gState.currentRecordId
        }));
        
        await callSheetDB_MUTATE(`${SHEETDB_API_URL}?sheet=HouseholdMembers`, 'POST', householdToSave);
      }
      
      onSaveSuccess();

    } catch(error) {
      handleError(error);
    }
  }
  
  function onSaveSuccess() {
    setLoading(false);
    Swal.fire({
      title: 'บันทึกสำเร็จ!', icon: 'success', timer: 1500, showConfirmButton: false
    });
    gState.changesToPush = {};
    const data = loadFromLocalStorage();
    gState.originalData = JSON.parse(JSON.stringify(data));
    el.saveBtn.disabled = true;
    el.saveBtn.innerHTML = `<i class="bi bi-cloud-arrow-up me-2"></i> บันทึก (0)`;
  }

  /*
   * ===================================================================
   * UTILITIES
   * ===================================================================
   */
  
  function setLoading(isLoading, message = 'กำลังโหลด...') {
    gState.isLoading = isLoading;
    if(SCREENS.loading) {
      SCREENS.loading.querySelector('p').textContent = message;
      SCREENS.loading.style.display = isLoading ? 'flex' : 'none';
    }
  }
  
  function handleError(error) {
    setLoading(false);
    Swal.fire('เกิดข้อผิดพลาด', error.message || error, 'error');
    if(el.loginBtn) el.loginBtn.disabled = false;
    if(el.saveBtn) {
      el.saveBtn.disabled = false;
      const changeCount = Object.keys(gState.changesToPush).length;
      el.saveBtn.innerHTML = `<i class="bi bi-cloud-arrow-up me-2"></i> บันทึก (${changeCount})`;
    }
  }
  
  // (ลบ Logger.log ออก)
  
</script>
    
  </body>
</html>
